<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lonopoly</title>
<style>
  :root{
    --bg:#f8f6f0; --card:#fff; --muted:#666;
    --red:#e54b4b; --yellow:#f0c23a; --black:#222; --orange:#ff8a3d;
    --board-size:92vmin;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#e8f7f1,#f7efe9);color:#111}
  .app{max-width:1100px;margin:10px auto;padding:12px}
  header{display:flex;align-items:center;justify-content:space-between}
  h1{font-size:18px;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:#222;color:#fff;padding:8px 12px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .small{padding:6px 8px;font-size:14px}
  .board-wrap{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;margin-top:12px}
  .board{width:var(--board-size);height:var(--board-size);background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08);padding:12px;display:grid;grid-template-columns:repeat(5,1fr);grid-template-rows:repeat(5,1fr);gap:8px}
  .slot{background:linear-gradient(180deg,#fff,#f7f7f7);border:1px solid #eee;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;min-height:64px;transition:all .16s;font-size:13px}
  .empty{background:transparent;border:0}
  .meta{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}
  .price{font-weight:700;margin-top:6px}
  .tokens{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .token{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .player-panel{width:340px;background:linear-gradient(180deg,#fff,#fcfcfc);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .player-row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .log{max-height:260px;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #f1f1f1}
  .status{font-size:13px;color:var(--muted)}
  .field{width:100%;padding:8px;border-radius:8px;border:1px solid #eee}
  .dice{width:66px;height:66px;border-radius:12px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-size:28px}
  .feedback{margin-top:8px;font-size:14px;color:#111;min-height:42px}
  .small-muted{font-size:12px;color:var(--muted)}
  @media (max-width:980px){ .player-panel{width:100%} .board-wrap{flex-direction:column;align-items:center} }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Lonopoly ‚Äî By Vewerty Ploik</h1>
    <div class="controls">
      <label>Players
        <select id="playerCount"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option> <option value="8">8</option> </select>
      </label>
      <button class="btn small" id="setupBtn">Setup</button>
    </div>
  </header>

  <div class="board-wrap">
    <div class="board" id="board" aria-label="Lonopoly edge board"></div>

    <div class="player-panel">
      <div id="setupArea">
        <div style="margin-bottom:8px">Enter nicknames (optional) ‚Äî choose player count then Setup</div>
        <div id="nameFields"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="startBtn">Start Game</button>
          <button class="btn small" id="reloadBtn">Reload</button>
        </div>
      </div>

      <div id="gameArea" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div style="font-weight:800" id="currentName">-</div>
            <div class="status" id="currentDetail">-</div>
          </div>
          <div style="text-align:center">
            <div class="dice" id="dice">‚Äî</div>
            <div class="feedback" id="feedback">‚Äî</div>
            <div style="display:flex;gap:8px;margin-top:6px;justify-content:center">
              <button class="btn" id="rollBtn">Roll</button>
              <button class="btn small" id="endBtn" disabled>End</button>
            </div>
          </div>
        </div>

        <div style="margin-bottom:8px"><strong>Players</strong></div>
        <div id="playersUI"></div>

        <div style="margin-top:12px">
          <div style="font-size:13px;margin-bottom:6px">Game Log</div>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:80">
  <div style="background:rgba(0,0,0,.45);position:absolute;inset:0"></div>
  <div id="modalCard" style="position:relative;background:#fff;padding:18px;border-radius:12px;max-width:560px;width:100%;z-index:81;box-shadow:0 10px 40px rgba(0,0,0,.35)"></div>
</div>

<script>
(() => {
  const ≈Å = '\u0141';
  // Extended slots: include optional tax/rent meta for display
  const SLOTS = [
    {id:0,name:'GO',emoji:'‚û°Ô∏è',type:'go'},
    {id:1,name:'Bank',emoji:'üè¶',type:'bank',cost:5,tax:5},
    {id:2,name:'Factory',emoji:'üè≠',type:'prop',cost:3,rent:2},
    {id:3,name:'Casino',emoji:'üé∞',type:'prop',cost:4,rent:3},
    {id:4,name:'Free Parking',emoji:'üÖøÔ∏è',type:'free'},
    {id:5,name:'Bowling',emoji:'üé≥',type:'prop',cost:3,rent:3},
   {id:6,name:'Arcade',emoji:'üéÆ',type:'prop',cost:3,rent:2},
    {id:7,name:'Stadium',emoji:'üèüÔ∏è',type:'prop',cost:4,rent:3},
 {id:8,name:'Go To Jail',emoji:'‚õìÔ∏è',type:'gotojail'},
{id:9,name:'Office',emoji:'üè¢',type:'prop',cost:4,rent:2},
    {id:10,name:'Climb',emoji:'üßó',type:'prop',cost:2,rent:1},
    {id:11,name:'Golf',emoji:'‚õ≥Ô∏è',type:'prop',cost:2,rent:2},
 {id:12,name:'Jail',emoji:'üö®',type:'jail'},
    {id:13,name:'School',emoji:'üè´',type:'prop',cost:5,rent:4},
    {id:14,name:'Hospital',emoji:'üè•',type:'prop',cost:5,rent:3},
    {id:15,name:'Playground',emoji:'üõù',type:'prop',cost:2,rent:1}
  ];

  const gridMap = new Array(25).fill(null);
  gridMap[0]=0; gridMap[1]=1; gridMap[2]=2; gridMap[3]=3; gridMap[4]=4;
  gridMap[9]=5; gridMap[14]=6; gridMap[19]=7;
  gridMap[24]=8; gridMap[23]=9; gridMap[22]=10; gridMap[21]=11; gridMap[20]=12;
  gridMap[15]=13; gridMap[10]=14; gridMap[5]=15;

  const PLAYER_TOKENS=['üêî','üê∏','ü¶à','ü¶¶','ü¶Ö','ü¶Å','üê∑','üêô'];
  const PLAYER_COLOR_VALUES=['#e54b4b','#04B85A','#29D8E3','#873807','#999494','#FF7308', '#FFA6E9 ', '#D60470'];

  let state={players:[],current:0,started:false,log:[]};
  let hasRolled = false; // anti-cheat: per-turn roll flag

  const $=id=>document.getElementById(id);
  const board=$('board'), nameFields=$('nameFields'), playersUI=$('playersUI'), logEl=$('log');
  const setupBtn=$('setupBtn'), startBtn=$('startBtn'), reloadBtn=$('reloadBtn');
  const diceEl=$('dice'), rollBtn=$('rollBtn'), endBtn=$('endBtn'), feedbackEl=$('feedback');

  function renderBoard(){
    board.innerHTML='';
    for(let i=0;i<25;i++){
      const mapped=gridMap[i]; const cell=document.createElement('div');
      if(mapped===null){cell.className='empty';}
      else{
        const s=SLOTS[mapped]; cell.className='slot slot-'+mapped;
        cell.dataset.slot=mapped;
        // Build price and rent/tax lines if present
        let extra = '';
        if(s.type==='prop' && s.cost!=null) extra += `<div class="small-muted">Price ${≈Å}${s.cost}</div>`;
        if((s.rent!=null)) extra += `<div class="small-muted">Rent ${≈Å}${s.rent}</div>`;
        if((s.type==='bank' && s.tax!=null)) extra += `<div class="small-muted">Tax ${≈Å}${s.tax}</div>`;
        cell.innerHTML=`<div style="font-size:22px">${s.emoji}</div><div class="meta">${s.name}</div>${extra}<div class="tokens" id="slotTokens-${mapped}"></div>`;
      }
      board.appendChild(cell);
    }
    refreshOwners();
  }

  function buildNameInputs(){
    nameFields.innerHTML=''; const pc=parseInt($('playerCount').value,10);
    for(let i=0;i<pc;i++){
      const wrapper=document.createElement('div');
      wrapper.style.display='flex'; wrapper.style.gap='8px'; wrapper.style.marginBottom='8px';
      wrapper.innerHTML=`<div class="token" style="width:40px;height:40px;border-radius:8px;background:${PLAYER_COLOR_VALUES[i]};display:flex;align-items:center;justify-content:center;font-size:20px">${PLAYER_TOKENS[i]}</div>
      <input id="pname${i}" class="field" placeholder="Player ${i+1} name (optional)" />`;
      nameFields.appendChild(wrapper);
    }
  }

  function startSetup(){ buildNameInputs(); $('setupArea').style.display='block'; $('gameArea').style.display='none'; $('currentName').textContent='-'; $('currentDetail').textContent='-'; diceEl.textContent='‚Äî'; feedback('‚Äî'); }

  function startGame(){
    const pc=parseInt($('playerCount').value,10);
    state.players=[]; for(let i=0;i<pc;i++){ const name=(document.getElementById('pname'+i).value||('Player '+(i+1)));
      state.players.push({id:i,name,token:PLAYER_TOKENS[i],color:PLAYER_COLOR_VALUES[i],pos:0,cash:20,inJail:false,bankrupt:false});
    }
    state.current=0; state.started=true; SLOTS.forEach(s=>s.owner=null); state.log=[];
    $('setupArea').style.display='none'; $('gameArea').style.display='block';
    renderPlayers(); renderBoard(); updateAll(); log(`${state.players.length} players started. Each has ${≈Å}20.`);
    // start with first player's turn UI
    showCurrentPlayerUI();
  }

  function renderPlayers(){
    playersUI.innerHTML=''; state.players.forEach(p=>{
      const row=document.createElement('div'); row.className='player-row';
      row.innerHTML=`<div class="token" style="width:44px;height:44px;border-radius:8px;background:${p.color};display:flex;align-items:center;justify-content:center;font-size:20px">${p.token}</div>
      <div style="flex:1"><div style="display:flex;justify-content:space-between"><strong>${escapeHtml(p.name)}</strong><div style="font-weight:800">${≈Å}${p.cash}</div></div><div class="status" id="pstat-${p.id}">${p.inJail?'In Jail':''}${p.bankrupt?' ‚Ä¢ BANKRUPT':''}</div></div>`;
      playersUI.appendChild(row);
    });
  }

  function refreshOwners(){ for(let si=0; si<SLOTS.length; si++){
    const el=document.querySelector('.slot-'+si); if(!el) continue; const s=SLOTS[si];
    if(s.owner!=null){ el.style.background=`linear-gradient(180deg, ${state.players[s.owner].color}22, #fff)`; el.style.borderColor=state.players[s.owner].color; } else{ el.style.background='linear-gradient(180deg,#fff,#f7f7f7)'; el.style.borderColor='#eee'; }
    const tokensC=document.getElementById('slotTokens-'+si); if(tokensC) tokensC.innerHTML='';
  }}

  function updateTokens(){
    for(let i=0;i<SLOTS.length;i++){ const c=document.getElementById('slotTokens-'+i); if(c) c.innerHTML=''; }
    state.players.forEach(p=>{ if(p.bankrupt) return; const c=document.getElementById('slotTokens-'+p.pos); if(!c) return; const t=document.createElement('div'); t.className='token'; t.style.width='22px'; t.style.height='22px'; t.style.borderRadius='50%'; t.style.background=p.color; t.style.color='#fff'; t.style.display='flex'; t.style.alignItems='center'; t.style.justifyContent='center'; t.textContent=p.token; c.appendChild(t); });
    state.players.forEach(p=>{ const s=$('pstat-'+p.id); if(s) s.textContent=`${p.inJail?'In Jail':''}${p.bankrupt?' ‚Ä¢ BANKRUPT':''}`; });
    playersUI.querySelectorAll('.player-row').forEach((row, idx)=>{ const cashDiv=row.querySelector('div[style*="font-weight:800"]'); if(cashDiv) cashDiv.textContent=`${≈Å}${state.players[idx].cash}`; });
  }

  function escapeHtml(s){ return (''+s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c])); }
  function log(msg){ const ts=new Date().toLocaleTimeString(); state.log.unshift(`[${ts}] ${msg}`); if(state.log.length>400) state.log.pop(); logEl.innerHTML=state.log.map(l=>`<div style="margin-bottom:6px">${l}</div>`).join(''); }

  function feedback(text){
    feedbackEl.innerHTML = text;
  }

  function rollAnimation(cb){ const duration=700, interval=80; let elapsed=0; const id=setInterval(()=>{ const v=Math.floor(Math.random()*6)+1; diceEl.textContent=v; elapsed+=interval; if(elapsed>=duration){ clearInterval(id); const final=Math.floor(Math.random()*6)+1; diceEl.textContent=final; cb(final); } }, interval); }

  function rollDiceFlow(){ 
    // anti-cheat guard - shouldn't happen b/c button is disabled, but double-check
    const p = state.players[state.current];
    if(hasRolled){ feedback('You already rolled this turn ‚Äî End Turn to continue.'); return; }
    if(!state.started){ return; }
    if(p.bankrupt){ feedback(`${p.name} is bankrupt.`); return; }
    if(p.inJail){ feedback(`${p.name} is in Jail and cannot roll.`); return; }

    hasRolled = true;
    rollBtn.disabled = true; // disable immediately
    endBtn.disabled = true;
    feedback('Rolling...');
    rollAnimation((d)=>{
      // show the roll number immediately in feedback
      diceEl.textContent = d;
      showLandingFlow(d);
    });
  }

  // Check if any player hit <= 0 -> immediately decide winner (player with most money)
  function checkForImmediateVictoryAfterLoss(changedPlayer){
    const loser = changedPlayer;
    if(loser.cash>0) return false;
    // mark loser bankrupt
    loser.bankrupt = true;
    log(`${loser.name} has reached ${≈Å}0 and is eliminated.`);
    const alive = state.players.filter(p => !p.bankrupt);
    if(alive.length===0){
      showModal(`<div style="font-weight:800">All players bankrupt ‚Äî no winner</div><div style="margin-top:12px"><button id="endOk" class="btn">OK</button></div>`, ()=>{
        document.getElementById('endOk').addEventListener('click',()=>{ hideModal(); endGame(null); });
      });
      return true;
    }
    // find richest
    let winner = alive[0];
    for(const p of alive){
      if(p.cash > winner.cash) winner = p;
    }
    showModal(`<div style="font-weight:800">${escapeHtml(winner.name)} wins!</div><div style="margin-top:8px">They have the most money: ${≈Å}${winner.cash}</div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="endOk" class="btn">OK</button></div>`, ()=>{
      document.getElementById('endOk').addEventListener('click',()=>{ hideModal(); endGame(winner); });
    });
    return true;
  }

  function endGame(winner){
    state.started = false;
    rollBtn.disabled = true;
    endBtn.disabled = true;
    hasRolled = false;
    if(winner) log(`${winner.name} wins with ${≈Å}${winner.cash}!`);
    else log(`Game ended.`);
    updateTokens();
  }

  function showLandingFlow(d){
    const p=state.players[state.current];
    if(p.bankrupt){ finalizeAfterLanding(); return; }
    // compute new pos on 16-space track (0..15)
    const oldPos = p.pos;
    const total = p.pos + d;
    const newPos = total % 16;
    if(total >= 16){
      p.cash += 2;
      log(`${p.name} passed GO and received ${≈Å}2`);
    }
    p.pos = newPos;
    updateTokens(); refreshOwners(); renderPlayers();
    const slot = SLOTS[newPos];

    // Build a short feedback summary for immediate display
    let fb = `üé≤ ${p.name} rolled a ${d} and landed on ${slot.emoji} ${slot.name}.`;

    if(slot.type==='prop' && slot.owner==null){
      fb += ` Available: Buy for ${≈Å}${slot.cost}.`;
      feedback(fb);
      const html=`<div style="font-weight:800">${escapeHtml(p.name)} rolled a ${d}</div><div style="margin-top:8px">${escapeHtml(p.name)} landed on <strong>${slot.emoji} ${slot.name}</strong></div>
             <div style="margin-top:10px">Buy for ${≈Å}${slot.cost}?</div>
             <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
               <button id="mBuy" class="btn">Buy</button><button id="mSkip" class="btn small">Skip</button>
             </div>`;
      showModal(html, ()=>{
        document.getElementById('mBuy').addEventListener('click',()=>{ buyProperty(p.id,slot.id); hideModal(); finalizeAfterLanding(); });
        document.getElementById('mSkip').addEventListener('click',()=>{ hideModal(); finalizeAfterLanding(); });
      });
      return;
    } else if(slot.type==='prop' && slot.owner!=null && slot.owner!==p.id){
      const rent=slot.rent;
      fb += ` Owes ${≈Å}${rent} to ${state.players[slot.owner].name}.`;
      feedback(fb);
      const html=`<div style="font-weight:800">${escapeHtml(p.name)} rolled a ${d}</div><div style="margin-top:8px">${escapeHtml(p.name)} landed on <strong>${slot.emoji} ${slot.name}</strong></div>
             <div style="margin-top:10px">You owe ${≈Å}${rent} to ${escapeHtml(state.players[slot.owner].name)}</div>
             <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
               <button id="mPay" class="btn">Pay</button>
             </div>`;
      showModal(html, ()=>{ document.getElementById('mPay').addEventListener('click',()=>{
          p.cash-=rent; state.players[slot.owner].cash+=rent;
          log(`${p.name} paid ${≈Å}${rent} rent to ${state.players[slot.owner].name}`);
          hideModal();
          if(checkForImmediateVictoryAfterLoss(p)) return;
          finalizeAfterLanding();
        }); });
      return;
    } else if(slot.type==='bank'){
      const tax = slot.tax || slot.cost || 5;
      fb += ` Pay ${≈Å}${tax}.`;
      feedback(fb);
      const html=`<div style="font-weight:800">${escapeHtml(p.name)} rolled a ${d}</div><div style="margin-top:8px">${escapeHtml(p.name)} landed on <strong>${slot.emoji} ${slot.name}</strong></div>
             <div style="margin-top:10px">Pay ${≈Å}${tax}</div>
             <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="payBank" class="btn">OK</button></div>`;
      showModal(html, ()=>{
        document.getElementById('payBank').addEventListener('click',()=>{
          p.cash-=tax; log(`${p.name} paid ${≈Å}${tax} at Bank`);
          hideModal();
          if(checkForImmediateVictoryAfterLoss(p)) return;
          finalizeAfterLanding();
        });
      });
      return;
    } else if(slot.type==='gotojail'){
      const jailIndex = SLOTS.findIndex(s=>s.type==='jail');
      p.pos = jailIndex;
      p.inJail = true;
      updateTokens();
      fb += ` Sent to Jail.`;
      feedback(fb);
      const html=`<div style="font-weight:800">${escapeHtml(p.name)} rolled a ${d}</div><div style="margin-top:8px">${escapeHtml(p.name)} landed on <strong>${slot.emoji} ${slot.name}</strong></div>
             <div style="margin-top:10px">You are sent to Jail.</div><div style="margin-top:8px">Would you like to pay ${≈Å}3 to leave Jail now?</div>
             <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
             <button id="jailYes" class="btn">Yes</button><button id="jailNo" class="btn small">No</button></div>`;
      showModal(html, ()=>{
        document.getElementById('jailYes').addEventListener('click',()=>{
          if(p.cash>=3){ p.cash-=3; p.inJail=false; p.pos=0; log(`${p.name} paid ${≈Å}3 and left Jail`); }
          else{ log(`${p.name} cannot afford to leave Jail`); }
          hideModal();
          if(checkForImmediateVictoryAfterLoss(p)) return;
          finalizeAfterLanding();
        });
        document.getElementById('jailNo').addEventListener('click',()=>{ hideModal(); finalizeAfterLanding(); });
      });
      return;
    } else { // free, jail visit, go...
      feedback(fb);
      finalizeAfterLanding();
      return;
    }
  }

  function finalizeAfterLanding(){
    updateTokens(); renderPlayers();
    endBtn.disabled = false; // allow ending turn
    // roll button remains disabled until end turn (anti-cheat)
    rollBtn.disabled = true;
    // if player in jail, ensure roll remains disabled
    const p = state.players[state.current];
    if(p.inJail){
      rollBtn.disabled = true;
    }
    // check for bankruptcy
    if(checkForImmediateVictoryAfterLoss(p)) return;
  }

  function buyProperty(pid,sid){
    const p=state.players[pid], slot=SLOTS[sid];
    if(p.cash>=slot.cost){
      p.cash-=slot.cost; slot.owner=pid; log(`${p.name} bought ${slot.name} for ${≈Å}${slot.cost}`);
      feedback(`${p.name} bought ${slot.emoji} ${slot.name} for ${≈Å}${slot.cost}.`);
      if(checkForImmediateVictoryAfterLoss(p)) return;
    } else { log(`${p.name} cannot afford ${slot.name}`); feedback(`${p.name} cannot afford ${slot.name}.`); }
    updateTokens(); renderPlayers();
  }

  function nextPlayerTurn(){
    if(!state.started) return;
    // advance to next alive player
    let attempts=0;
    do{
      state.current=(state.current+1)%state.players.length;
      attempts++;
      if(attempts>100) break;
    } while(state.players[state.current].bankrupt);
    const p=state.players[state.current];
    showCurrentPlayerUI();
    // If player is in jail, immediately show modal asking to pay ≈Å3.
    if(p.inJail){
      rollBtn.disabled = true;
      endBtn.disabled = false; // allow skipping turn
      const html = `<div style="font-weight:800">${escapeHtml(p.name)}</div><div style="margin-top:8px">Would you like to pay ${≈Å}3 to leave Jail now?</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                      <button id="jailYes" class="btn">Yes</button><button id="jailNo" class="btn small">No</button>
                    </div>`;
      showModal(html, ()=>{
        document.getElementById('jailYes').addEventListener('click',()=>{
          if(p.cash>=3){
            p.cash -= 3;
            p.inJail = false;
            p.pos = 0;
            log(`${p.name} paid ${≈Å}3 and left Jail`);
            hideModal();
            updateTokens(); renderPlayers();
            if(checkForImmediateVictoryAfterLoss(p)) return;
            // allow rolling after paying
            rollBtn.disabled = false;
            endBtn.disabled = true;
            hasRolled = false;
            feedback(`${p.name} paid ${≈Å}3 and left Jail. You may roll.`);
          } else {
            log(`${p.name} cannot afford to leave Jail`);
            hideModal();
            rollBtn.disabled = true;
            endBtn.disabled = false;
            feedback(`${p.name} cannot afford to pay ${≈Å}3 to leave Jail.`);
            updateTokens();
          }
        });
        document.getElementById('jailNo').addEventListener('click',()=>{
          hideModal();
          rollBtn.disabled = true;
          endBtn.disabled = false;
          feedback(`${p.name} chose not to pay. Remains in Jail.`);
        });
      });
    } else {
      // normal turn start
      rollBtn.disabled = false;
      endBtn.disabled = true;
      hasRolled = false;
      feedback(`${p.name}'s turn ‚Äî click Roll.`);
      updateTokens();
    }
  }

  function showCurrentPlayerUI(){
    const p = state.players[state.current];
    $('currentName').textContent = p.name;
    $('currentDetail').textContent = p.inJail ? 'In Jail' : '';
    // ensure dice shows dash if not rolled
    diceEl.textContent = '‚Äî';
  }

  function showModal(html,cb){ $('modalCard').innerHTML=html; $('modal').style.display='flex'; if(cb) cb(); }
  function hideModal(){ $('modal').style.display='none'; }

  setupBtn.addEventListener('click',startSetup);
  startBtn.addEventListener('click',startGame);
  reloadBtn.addEventListener('click',()=>location.reload());
  rollBtn.addEventListener('click',()=>{
    const p = state.players[state.current];
    if(!state.started){ return; }
    if(p.bankrupt) { feedback(`${p.name} is bankrupt.`); return; }
    if(p.inJail){ feedback(`${p.name} is in Jail and cannot roll.`); return; }
    if(hasRolled){ feedback('You already rolled this turn ‚Äî click End Turn to continue.'); return; }
    rollDiceFlow();
  });
  endBtn.addEventListener('click',()=>{
    // Ending turn: allow next player to roll
    hasRolled = false;
    rollBtn.disabled = true; // will be toggled in nextPlayerTurn depending on jail
    endBtn.disabled = true;
    nextPlayerTurn();
  });

  function updateAll(){ renderBoard(); renderPlayers(); updateTokens(); showCurrentPlayerUI(); }

  // initial UI
  startSetup(); renderBoard();
})();
</script>
</body>
</html>
